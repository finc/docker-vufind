stages:
- image
- mirror

httpd_image:
  stage: image
  image: docker:latest
  services:
  - docker:dind
  script: |
    mkdir -p ~/.docker && echo "$DOCKER_AUTH_CONFIG" >~/.docker/config.json
    export suffix=`expr $CI_COMMIT_TAG ':' 'httpd/2.4-\(.*\)'`
    docker build --pull -t services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd:2.4-${suffix} -f dockerfiles/Dockerfile.httpd:2.4 .
    docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd:2.4-${suffix}
    for tag in "latest" "2.4"; do
      docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd:2.4-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd:${tag}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd:${tag}
    done
  tags:
  - docker
  only:
  - /^httpd\/2.4/
  except:
  - branches

httpd_vufind1_image:
  stage: image
  image: docker:latest
  services:
  - docker:dind
  script: |
    mkdir -p ~/.docker && echo "$DOCKER_AUTH_CONFIG" >~/.docker/config.json
    export tag=`expr ${CI_COMMIT_TAG} ':' '^httpd-vufind1/2.4-\(.*\)$'`
    docker build --pull -t services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd-vufind1:2.4-${suffix} -f dockerfiles/Dockerfile.httpd-vufind1:2.4 .
    docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd-vufind1:2.4-${suffix}
    for tag in "latest" "2.4"; do
      docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd-vufind1:2.4-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd-vufind1:${tag}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/httpd-vufind1:${tag}
    done
  tags:
  - docker
  only:
  - /^httpd-vufind1\//
  except:
  - branches

nginx_image:
  stage: image
  image: docker:latest
  services:
  - docker:dind
  script: |
    mkdir -p ~/.docker && echo "$DOCKER_AUTH_CONFIG" >~/.docker/config.json
    export suffix=`expr ${CI_COMMIT_TAG} ':' '^nginx/1.13-\(.*\)$'`
    docker build --pull -t services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:1.13-${suffix} -f dockerfiles/Dockerfile.nginx:1.13 .
    docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:${tag}-${suffix}
    for tag in "latest" "1.13"; do
      docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:1.13-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:${tag}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:${tag}
    done

  tags:
  - docker
  only:
  - /^nginx\//
  except:
  - branches

php_7_image:
  stage: image
  image: docker:latest
  services:
  - docker:dind
  script: |
    mkdir -p ~/.docker && echo "$DOCKER_AUTH_CONFIG" >~/.docker/config.json
    export suffix=`expr ${CI_COMMIT_TAG} ':' '^php/7-\(.*\)$'`
    for tag in 7 7-debug; do
      docker build -t services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}-${suffix} -f dockerfiles/Dockerfile.php:${tag} .
      docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}-${suffix}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}
    done
    docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:7-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:latest
    docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:latest
  tags:
  - docker
  only:
  - /^php\/7/
  except:
  - branches

php_5_image:
  stage: image
  image: docker:latest
  services:
  - docker:dind
  script: |
    mkdir -p ~/.docker && echo "$DOCKER_AUTH_CONFIG" >~/.docker/config.json
    export suffix=`expr ${CI_COMMIT_TAG} ':' '^php/5-\(.*\)$'`

    for tag in 5 5-debug; do
      docker build -t services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}-${suffix} -f dockerfiles/Dockerfile.php:${tag} .
      docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}-${suffix}
      docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php:${tag}
    done
  tags:
  - docker
  only:
  - /^php\/5/
  except:
  - branches

php_5_vufind1_image:
  stage: image
  image: docker:latest
  services:
  - docker:dind
  script: |
    mkdir -p ~/.docker && echo "$DOCKER_AUTH_CONFIG" >~/.docker/config.json
    export suffix=`expr ${CI_COMMIT_TAG} ':' '^php-vufind1/5.3-(.*\)$'`
    docker build -t services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php-vufind1:5.3-debug-${suffix} -f dockerfiles/Dockerfile.php-vufind1:5.3-debug .
    docker tag services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php-vufind1:5.3-debug-${suffix} services.ub.uni-leipzig.de:11443/bdd_dev/vufind/php-vufind1:5.3-debug
    docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:5.3-debug-${suffix}
    docker push services.ub.uni-leipzig.de:11443/bdd_dev/vufind/nginx:5.3-debug
  tags:
  - docker
  only:
  - /^php-vufind1\//
  except:
  - branches

github_mirror:
  stage: mirror
  image:
    name: alpine/git
    entrypoint: [ "/bin/sh", "-c" ]
  variables:
    GIT_STRATEGY: clone
    GIT_CHECKOUT: "false"
  script:
  - git checkout ${CI_COMMIT_REF_NAME}
  - git remote add github https://useltmann:${GITHUB_TOKEN}@github.com/finc/docker-vufind2.git
  - git push --mirror github
  - git branch -a
  tags:
  - docker
